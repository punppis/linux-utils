#!/usr/bin/env bash
set -euo pipefail

# create-package: Create a new package directory with a bash script template
# Usage: ./create-package <package-name>
#        echo "<package-name>" | ./create-package

# Color helper functions
red() {
  if [[ -t 1 ]]; then
    echo -e "\033[31m$*\033[0m" >&2
  else
    echo "$*" >&2
  fi
}

green() {
  if [[ -t 1 ]]; then
    echo -e "\033[32m$*\033[0m"
  else
    echo "$*"
  fi
}

# Read package name from stdin or CLI args
if [[ $# -gt 0 ]]; then
  package_name="$*"
elif [[ ! -t 0 ]]; then
  # Reading from pipe
  read -r package_name
else
  red "Error: Package name required"
  echo "Usage: ./create-package <package-name>" >&2
  echo "       echo \"<package-name>\" | ./create-package" >&2
  exit 1
fi

# Sanitize the package name:
# 1. Convert to lowercase
# 2. Replace any run of whitespace characters with a single dash
# 3. Remove any characters that are not [a-z0-9-]
# 4. Collapse multiple consecutive dashes into one
# 5. Remove leading/trailing dashes
sanitized=$(echo "$package_name" | \
  tr '[:upper:]' '[:lower:]' | \
  sed 's/[[:space:]]\+/-/g' | \
  sed 's/[^a-z0-9-]//g' | \
  sed 's/-\+/-/g' | \
  sed 's/^-//;s/-$//')

# Check if sanitized name is empty
if [[ -z "$sanitized" ]]; then
  red "Error: Package name '$package_name' results in empty string after sanitization"
  echo "Package names must contain at least one alphanumeric character" >&2
  exit 1
fi

# Check if directory already exists
if [[ -d "$sanitized" ]]; then
  red "Error: Directory '$sanitized' already exists"
  exit 1
fi

# Create the package directory (using mkdir without -p to avoid race condition)
if ! mkdir "$sanitized" 2>/dev/null; then
  red "Error: Failed to create directory '$sanitized' (may have been created concurrently)"
  exit 1
fi

# Create the package script
script_path="$sanitized/$sanitized"
cat > "$script_path" <<EOF
#!/usr/bin/env bash
set -euo pipefail

# $sanitized: Package script
# Generated by create-package

echo "Hello from $sanitized!"
EOF

# Make the script executable
chmod +x "$script_path"

green "âœ“ Created package '$sanitized'"
echo "  Script: $script_path"

