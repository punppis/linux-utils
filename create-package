#!/usr/bin/env bash
set -euo pipefail

OUTPUT_FOLDER="./packages"

red() {
  if [[ -t 1 ]]; then
    echo -e "\033[31m$*\033[0m" >&2
  else
    echo "$*" >&2
  fi
}

green() {
  if [[ -t 1 ]]; then
    echo -e "\033[32m$*\033[0m"
  else
    echo "$*"
  fi
}

sanitize() {
  local input="$*"

  printf '%s' "$input" \
    | tr '[:upper:]' '[:lower:]' \
    | sed -E 's/[[:space:]_]+/-/g' \
    | sed -E 's/[^a-z0-9-]+//g' \
    | sed -E 's/-+/-/g; s/^-+//; s/-+$//'
}

raw_name="${*:-}"
if [[ -z "$raw_name" && ! -t 0 ]]; then
  raw_name="$(cat)"
fi

if [[ -z "$raw_name" ]]; then
  red "Error: Package name required"
  echo "Usage: ./create-package <package-name>" >&2
  echo "       echo \"<package-name>\" | ./create-package" >&2
  exit 1
fi

PACKAGE_NAME="$(sanitize "$raw_name")"

if [[ -z "$PACKAGE_NAME" ]]; then
  red "Error: Package name '$raw_name' results in empty string after sanitization"
  exit 1
fi

mkdir -p "$OUTPUT_FOLDER"

PACKAGE_DIR="${OUTPUT_FOLDER}/${PACKAGE_NAME}"
PACKAGE_SCRIPT="${PACKAGE_DIR}/${PACKAGE_NAME}"

if [[ -e "$PACKAGE_DIR" ]]; then
  red "Error: Package already exists: $PACKAGE_DIR"
  exit 1
fi

if ! mkdir "$PACKAGE_DIR" 2>/dev/null; then
  red "Error: Failed to create directory '$PACKAGE_DIR' (may have been created concurrently)"
  exit 1
fi

cat > "$PACKAGE_SCRIPT" <<EOF
#!/usr/bin/env bash

set -euo pipefail

echo "Hello from my package $PACKAGE_NAME!"

exit 0
EOF

chmod +x "$PACKAGE_SCRIPT"

green "Created package '$PACKAGE_NAME'"
green "  Folder: $PACKAGE_DIR"
green "  Script: $PACKAGE_SCRIPT"
